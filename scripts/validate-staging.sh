#!/bin/bash
################################################################################
# NEXO - Validaรงรฃo de Deploy em Staging
# 
# Executa validaรงรฃo completa apรณs deploy em ambiente de staging
# Uso: ./scripts/validate-staging.sh [STAGING_URL]
################################################################################

set -o pipefail

STAGING_URL="${1:-http://localhost:8080}"
TIMEOUT=10

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

TOTAL=0
PASSED=0
FAILED=0

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "  ๐ NEXO - Validaรงรฃo de Deploy Staging"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ URL: $STAGING_URL"
echo "๐ Data: $(date)"
echo ""

# Funรงรฃo para testar endpoint
test_endpoint() {
    local endpoint="$1"
    local expected="$2"
    local description="$3"
    
    ((TOTAL++))
    printf "  %-50s" "$description"
    
    local response=$(curl -s -w "\n%{http_code}" "$STAGING_URL$endpoint" --max-time $TIMEOUT 2>/dev/null)
    local http_code=$(echo "$response" | tail -n1)
    
    if [ "$http_code" = "$expected" ]; then
        echo -e "${GREEN}โ PASS${NC} (HTTP $http_code)"
        ((PASSED++))
        return 0
    else
        echo -e "${RED}โ FAIL${NC} (Expected $expected, got $http_code)"
        ((FAILED++))
        return 1
    fi
}

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ 1. VERIFICAรรES BรSICAS"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

test_endpoint "/health" "200" "Health Check"
test_endpoint "/api/v1/ping" "200" "Ping"

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ 2. AUTENTICAรรO"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# Testar rota protegida sem token (deve retornar 401)
((TOTAL++))
printf "  %-50s" "Rota protegida sem token"
response=$(curl -s -w "\n%{http_code}" "$STAGING_URL/api/v1/servicos" --max-time $TIMEOUT 2>/dev/null)
http_code=$(echo "$response" | tail -n1)
if [ "$http_code" = "401" ] || [ "$http_code" = "403" ]; then
    echo -e "${GREEN}โ PASS${NC} (HTTP $http_code - seguranรงa OK)"
    ((PASSED++))
else
    echo -e "${RED}โ FAIL${NC} (Esperado 401/403, recebeu $http_code)"
    ((FAILED++))
fi

# Testar que endpoint de login aceita POST
((TOTAL++))
printf "  %-50s" "Endpoint de login disponรญvel"
response=$(curl -s -w "\n%{http_code}" -X POST "$STAGING_URL/api/v1/auth/login" -H "Content-Type: application/json" -d '{}' --max-time $TIMEOUT 2>/dev/null)
http_code=$(echo "$response" | tail -n1)
if [ "$http_code" = "400" ] || [ "$http_code" = "401" ] || [ "$http_code" = "422" ]; then
    echo -e "${GREEN}โ PASS${NC} (HTTP $http_code - endpoint ativo)"
    ((PASSED++))
else
    echo -e "${RED}โ FAIL${NC} (Esperado 400/401/422, recebeu $http_code)"
    ((FAILED++))
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ 3. SWAGGER/DOCS"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

test_endpoint "/swagger/index.html" "200" "Swagger UI"

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โฑ๏ธ  4. PERFORMANCE"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# Testar tempo de resposta do health check
((TOTAL++))
printf "  %-50s" "Tempo de resposta < 500ms"
start_time=$(date +%s%3N)
curl -s "$STAGING_URL/health" --max-time $TIMEOUT > /dev/null 2>&1
end_time=$(date +%s%3N)
response_time=$((end_time - start_time))

if [ $response_time -lt 500 ]; then
    echo -e "${GREEN}โ PASS${NC} (${response_time}ms)"
    ((PASSED++))
else
    echo -e "${YELLOW}โ WARN${NC} (${response_time}ms - lento)"
    ((PASSED++))
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "  ๐ RESUMO DA VALIDAรรO"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "  Total de testes:   $TOTAL"
echo -e "  ${GREEN}Aprovados:${NC}         $PASSED"
echo -e "  ${RED}Falhados:${NC}          $FAILED"
echo ""

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${GREEN}  โ VALIDAรรO APROVADA! Deploy estรก operacional.${NC}"
    echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    exit 0
else
    echo -e "${RED}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${RED}  โ VALIDAรรO FALHOU! Verifique os erros acima.${NC}"
    echo -e "${RED}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    exit 1
fi
